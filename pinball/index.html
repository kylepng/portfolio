<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>3D Pinball for Windows - Space Cadet</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; overflow: hidden; }
    #status { color: #fff; padding: 20px; text-align: center; }
    canvas.emscripten { border: 0; background: #000; display: block; }
  </style>
</head>
<body>
  <div id="status">Loading...</div>
  <progress hidden id="progress" max="100" value="0"></progress>
  <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" style="display:none" tabindex="0"></canvas>

  <script>
    // Auto-focus canvas
    window.addEventListener('load', () => setTimeout(() => {
      const c = document.getElementById('canvas');
      if (c) c.focus();
    }, 1500));

    document.addEventListener('click', () => {
      const c = document.getElementById('canvas');
      if (c && c.style.display !== 'none') c.focus();
    });
  </script>

  <script>
    // Master volume control - intercept Web Audio API before game loads
    (function() {
      var OrigAC = window.AudioContext || window.webkitAudioContext;
      if (!OrigAC) return;
      var origConnect = AudioNode.prototype.connect;
      var masterGain = null;
      var realCtx = null;

      function PatchedAC() {
        realCtx = new OrigAC();
        masterGain = realCtx.createGain();
        masterGain.gain.value = 0.15; // Default 15% volume
        origConnect.call(masterGain, realCtx.destination);
        window._masterGain = masterGain;
        window._audioCtx = realCtx;
        return realCtx;
      }
      PatchedAC.prototype = OrigAC.prototype;
      Object.defineProperty(PatchedAC, 'name', { value: 'AudioContext' });
      window.AudioContext = window.webkitAudioContext = PatchedAC;

      // Route all connections to destination through master gain
      AudioNode.prototype.connect = function(dest, output, input) {
        if (realCtx && dest === realCtx.destination && masterGain) {
          return origConnect.call(this, masterGain, output);
        }
        return origConnect.apply(this, arguments);
      };

      // Parent frame volume control
      window.setMasterVolume = function(v) {
        if (masterGain) masterGain.gain.value = v;
      };
    })();
  </script>

  <script>
    var statusElement = document.getElementById("status");
    var progressElement = document.getElementById("progress");
    var Module = {
      preRun: [],
      postRun: [],
      print: function() {
        var e = document.getElementById("output");
        return e && (e.value = ""), function(e) {
          arguments.length > 1 && (e = Array.prototype.slice.call(arguments).join(" ")),
          console.log(e)
        }
      }(),
      printErr: function(e) {
        arguments.length > 1 && (e = Array.prototype.slice.call(arguments).join(" ")),
        console.error(e)
      },
      canvas: function() {
        var e = document.getElementById("canvas");
        return e.addEventListener("webglcontextlost", function(e) {
          alert("WebGL context lost. Reload the page."),
          e.preventDefault()
        }, !1), e
      }(),
      setStatus: function(e) {
        if (Module.setStatus.last || (Module.setStatus.last = {time: Date.now(), text: ""}),
            e !== Module.setStatus.last.text) {
          var t = e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),
              n = Date.now();
          if (!(t && n - Module.setStatus.last.time < 30)) {
            if (Module.setStatus.last.time = n, Module.setStatus.last.text = e, t)
              e = t[1],
              progressElement.value = 100 * parseInt(t[2]),
              progressElement.max = 100 * parseInt(t[4]),
              progressElement.hidden = !1;
            else
              progressElement.value = null,
              progressElement.max = null,
              progressElement.hidden = !0,
              document.getElementById("canvas").style.display = "";
            statusElement.innerHTML = e,
            "" === e ? (statusElement.style.display = "none", progressElement.style.display = "none")
                     : (statusElement.style.display = "", progressElement.style.display = "")
          }
        }
      },
      totalDependencies: 0,
      monitorRunDependencies: function(e) {
        this.totalDependencies = Math.max(this.totalDependencies, e),
        Module.setStatus(e ? "Preparing... (" + (this.totalDependencies - e) + "/" + this.totalDependencies + ")" : "All downloads complete.")
      }
    };
    Module.setStatus("Loading...");
    window.onerror = function() {
      Module.setStatus("Error - see console"),
      Module.setStatus = function(e) { e && Module.printErr("[post-exception] " + e) }
    }
  </script>
  <script async src="SpaceCadetPinball.js"></script>
</body>
</html>
